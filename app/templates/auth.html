{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1>QTSP Authentication</h1>
        <div id="content" class="content-wrap1 content-center col-md-11 col-sm-11">
            <div class="genericErrors" id="genericErrorsDesc"></div>
            <button id="fetchButton" onclick="serviceAuthentication()">Get Access Token</button>
            <div id="inputContainer">
                <a id="link_to_wallet">Go to EUDI Wallet</a>
            </div>
            <div id="temp">
                <p id="result">Placeholder for the EUDI Wallet link</p>
                <p id="description">After authorization the wallet will redirect to a link. Introduce link redirect to in the input box below.</p>
                <input type="text" id="authLink" placeholder="Enter your response here">
                <button id="submitButton">Submit Text</button>
                <a id="link_to_continue">Continue</a>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('inputContainer').hidden = true;
    document.getElementById('temp').hidden = true;
    document.getElementById('link_to_continue').hidden = true;

    async function serviceAuthentication() {
        const response = await fetch('{{redirect_url}}/service_authorization');

        if(response.ok){
            data = response.json()
                .then(
                    d => {
                        console.log(d);
                        if (d && d["location"]) {
                            document.getElementById('link_to_wallet').href = d["location"];
                            document.getElementById('result').textContent=d["location"];
                            document.getElementById('inputContainer').hidden = false;
                            document.getElementById('temp').hidden = false;
                        } else {
                            console.error('Expected "location" key in the response');
                            document.getElementById("genericErrorsDesc").textContent = "Url to wallet not found.";
                        }
                    }
                );
        }
        else{
            data = response.text()
                .then(message => {
                    console.log(message);
                    document.getElementById("genericErrorsDesc").textContent = message;
                }
            )
        }
    }

    document.getElementById('submitButton').addEventListener('click', function(){
        const userInput = document.getElementById('authLink').value;
        document.getElementById('link_to_continue').href = userInput;
        document.getElementById('link_to_continue').hidden = false;
    });

</script>
{% endblock %}